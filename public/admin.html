<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Suits N Glam</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    body { background:#f8f9fa; }
    .nav-login-area { visibility:visible !important; }
    .img-preview { width:80px; height:80px; object-fit:cover; border-radius:10px; margin-right:6px; }
    .video-preview { width:160px; border-radius:10px; }
    .home-icon { font-size:1.6rem; cursor:pointer; margin-right:12px; }
    .btn-login { background:#ff3f33; color:#fff; border-radius:6px; padding:6px 14px; border:none; font-weight:600; }
    .btn-login:hover { background:#ff2b1f; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg" style="background-color:#e3f2fd;">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Suits N Glam</a>

    <div class="ms-auto d-flex align-items-center">
      <i class="bi bi-house-fill home-icon" title="Home" onclick="location.href='index.html'"></i>
      <span class="badge bg-danger me-3">ADMIN</span>
      <img id="accountIcon" style="width:34px;height:34px;border-radius:50%;cursor:pointer;">
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h2>Admin Dashboard</h2>

  <div class="card p-4 mt-3">
    <h5>Add Product</h5>
    <div class="row g-3 mt-2">

      <div class="col-md-4">
        <label class="form-label">Name</label>
        <input id="p_name" class="form-control" placeholder="Product name">
      </div>

      <div class="col-md-2">
        <label class="form-label">Price (₹ / metre)</label>
        <input id="p_price" type="number" class="form-control" placeholder="Price only numbers">
      </div>

      <div class="col-md-2">
        <label class="form-label">Stock</label>
        <input id="p_stock" type="number" class="form-control" placeholder="Quantity">
      </div>

      <div class="col-md-4">
        <label class="form-label">Category</label>
        <select id="p_category" class="form-select">
          <option value="summer">Summer</option>
          <option value="winter">Winter</option>
          <option value="wedding">Wedding</option>
          <option value="casuals">Casuals</option>
          <option value="dailywear">Daily Wear</option>
          <option value="premiumwear">Premium Wear</option>
          <option value="bestdeals">Best Deals</option>
          <option value="sales">Sales</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Description</label>
        <textarea id="p_desc" class="form-control" rows="3"></textarea>
      </div>

      <div class="col-12">
        <label class="form-label">Images (2–5) — upload from gallery</label>
        <input id="p_images" type="file" class="form-control" accept="image/*" multiple>
        <small class="text-muted">Select 2–5 images. Images will be saved as base64 for demo/local hosting.</small>
        <div id="imgPreview" class="d-flex mt-2"></div>
      </div>

      <div class="col-12">
        <label class="form-label">Video (optional)</label>
        <input id="p_video" type="file" class="form-control" accept="video/*">
        <div id="vidPreview" class="mt-2"></div>
      </div>

      <div class="col-12">
        <label class="form-check">
          <input id="p_sale" type="checkbox" class="form-check-input">
          <span class="form-check-label">Put on SALE</span>
        </label>
      </div>

    </div>

    <div class="mt-3">
      <button class="btn btn-success" onclick="adminAddProduct()">Add Product</button>
      <button class="btn btn-secondary ms-2" onclick="renderAdminProducts()">Refresh List</button>
      <button class="btn btn-danger ms-2" onclick="adminLogout()">Logout</button>
    </div>
  </div>

  <div class="mt-4">
    <h5>All Products</h5>
    <div id="productsAdminList"></div>
  </div>
</div>

<script>
/* helpers for inline previews */
function fileToBase64(file){ return new Promise(resolve => { const r = new FileReader(); r.onload = ()=>resolve(r.result); r.readAsDataURL(file); }); }

document.getElementById("p_images").addEventListener("change", async function(){
  const preview = document.getElementById("imgPreview");
  preview.innerHTML = "";
  const files = [...this.files].slice(0,5);
  for (const f of files){
    const b = await fileToBase64(f);
    const img = document.createElement("img");
    img.src = b;
    img.className = "img-preview";
    preview.appendChild(img);
  }
});

document.getElementById("p_video").addEventListener("change", async function(){
  const preview = document.getElementById("vidPreview");
  preview.innerHTML = "";
  if (this.files.length){
    const b = await fileToBase64(this.files[0]);
    preview.innerHTML = `<video class="video-preview" controls><source src="${b}"></video>`;
  }
});

/* ADMIN ACTIONS (call server, fallback to local if server rejects) */
async function adminAddProduct(){
  const name = document.getElementById("p_name").value.trim();
  const price = Number(document.getElementById("p_price").value);
  const stock = Number(document.getElementById("p_stock").value || 0);
  const category = document.getElementById("p_category").value;
  const description = document.getElementById("p_desc").value.trim();
  const sale = document.getElementById("p_sale").checked;

  if (!name || !price || !category){
    return alert("Please fill name, price and category");
  }

  // images -> base64
  const images = [];
  for (let f of document.getElementById("p_images").files) {
    images.push(await fileToBase64(f));
  }
  if (images.length < 2) {
    if (!confirm("Less than 2 images selected. Continue?")) return;
  }

  let video = "";
  if (document.getElementById("p_video").files.length) {
    video = await fileToBase64(document.getElementById("p_video").files[0]);
  }

  const body = { name, price, stock, category, description, images, video, sale };

  try {
    const res = await fetch("/api/admin/products", { method:"POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(body) });
    const data = await res.json();
    if (data.success) {
      alert("Product added successfully");
      renderAdminProducts();
      // clear inputs
      document.getElementById("p_name").value = "";
      document.getElementById("p_price").value = "";
      document.getElementById("p_stock").value = "";
      document.getElementById("p_desc").value = "";
      document.getElementById("p_images").value = "";
      document.getElementById("imgPreview").innerHTML = "";
      document.getElementById("p_video").value = "";
      document.getElementById("vidPreview").innerHTML = "";
      document.getElementById("p_sale").checked = false;
      return;
    } else {
      throw new Error("Server returned failure");
    }
  } catch (err) {
    // fallback: add to localStorage (for testing / static demo)
    const products = JSON.parse(localStorage.getItem("products") || "[]");
    const newP = { _id: "local_"+Date.now(), name, price, stock, category, description, images, video, sale, createdAt:new Date().toISOString() };
    products.unshift(newP);
    localStorage.setItem("products", JSON.stringify(products));
    alert("Product saved locally (server failed).");
    renderAdminProducts();
  }
}

/* delete product - attempt server then local fallback */
async function deleteProduct(id){
  if (!confirm("Delete product permanently?")) return;
  try {
    const res = await fetch(`/api/admin/products/${encodeURIComponent(id)}`, { method: "DELETE" });
    if (res.ok) {
      alert("Deleted from server");
      renderAdminProducts();
      return;
    }
  } catch (e) { /* ignore */ }

  // fallback local deletion
  const products = JSON.parse(localStorage.getItem("products") || "[]");
  const idx = products.findIndex(p => p._id === id);
  if (idx >= 0) {
    products.splice(idx,1);
    localStorage.setItem("products", JSON.stringify(products));
    alert("Deleted locally");
    renderAdminProducts();
  } else {
    alert("Delete failed");
  }
}

/* render admin list */
async function renderAdminProducts(){
  const out = document.getElementById("productsAdminList");
  out.innerHTML = "Loading...";
  try {
    const res = await fetch("/api/products/category/all");
    if (!res.ok) throw new Error("no server list");
    const products = await res.json();
    out.innerHTML = products.map(p => `
      <div class="card p-2 mb-2">
        <div class="d-flex align-items-center">
          <img src="${p.images?.[0]||''}" class="img-preview" />
          <div class="ms-2 flex-grow-1">
            <strong>${p.name}</strong><br>₹${p.price} — ${p.category}
            ${p.sale ? `<span class="badge bg-primary ms-2">SALE</span>` : ""}
            ${p.stock === 0 ? `<span class="badge bg-danger ms-2">OUT</span>` : ""}
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary mb-1" onclick="window.location.href='product.html?id=${p._id}'">Open</button>
            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p._id}')"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </div>
    `).join("");
    return;
  } catch (err) {
    // fallback: localStorage products (demo)
    const products = JSON.parse(localStorage.getItem("products") || "[]");
    if (!products.length) { out.innerHTML = "<p>No products found.</p>"; return; }
    out.innerHTML = products.map(p => `
      <div class="card p-2 mb-2">
        <div class="d-flex align-items-center">
          <img src="${p.images?.[0]||''}" class="img-preview" />
          <div class="ms-2 flex-grow-1">
            <strong>${p.name}</strong><br>₹${p.price} — ${p.category}
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary mb-1" onclick="window.location.href='product.html?id=${p._id}'">Open</button>
            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p._id}')"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </div>
    `).join("");
  }
}

/* admin guard & init */
function adminLogout() {
  localStorage.removeItem("adminLoggedIn");
  localStorage.removeItem("sg_user");
  window.location.href = "index.html";
}

document.addEventListener("DOMContentLoaded", () => {
  const raw = localStorage.getItem("sg_user");
  if (!raw) return location.href = "index.html";
  const user = JSON.parse(raw);
  if (user.email !== "sohabrar10@gmail.com") return location.href = "index.html";

  // show user pic
  const acc = document.getElementById("accountIcon");
  acc.src = user.picture || "";
  acc.style.display = acc.src ? "block" : "none";

  renderAdminProducts();
});
</script>

<script src="js/app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
